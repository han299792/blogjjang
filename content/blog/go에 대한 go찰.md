---
title: go에 대한 go찰
date: 2025-04-29
tags:
  - develop
  - golang
draft: false
---
당근마켓에서 go를 도입하고 4년간의 도입

- go 사용 현황
golang을 사용하는 레포지토리 수 200+ golang을 사용하는 사람 수 50+
1초에 8만개 정도 요청을 받고 있음
인프라 스펙
이러한 요청을 문제 없이 처리하고 여러 서비스를 개발하면서 겪었던 내용에 대해 얘기할 예정


- go를 시작한 계기
	- 고언어가 있는지 한번 알게되는 상황이 벌어짐
	- 고언어로 무엇을 만들었는지 한번 찾아봄
	- 고언어에 대해 관심이 가서 장단점을 찾아봄
	- 가볍게 두어개 로직을 작성해봄
	- 실제 업무에 도입할지 고민하면서 어느 회사가 쓰는지 한 번 찾아봄
	- 여러 사람들이 작성한 글들을 보면서 상상함
	- 그리고 공부를 제대로 시작함
- rails 서버로 감당하기 어려운 상황이 발견됨 
	- 장기적으로, 현재 리소스로 go가 가장 적합한 선택 

go의 장점 
1. 컴파일 속도가 빠르고 효율적
2. 동시성 
3. 언어단순 개발 생산성이 뛰어남

아쉬운점
에러처리가 번거로움 각 함수를 정의할 때 에러를 반환하도록 설계하기 때문에, 이를 체크하고 처리해야 함
대규모 힙을 가진 시스템에서 성능 저하를 일으킬 수 있음
제네릭 사용이 제한됨

성능이슈가 있다면 뭐때문일까
1. 뮤텍스가 동작하는 모드가 상황에 따라 다르다는거아시나요? 
	메모리가 어느 순간 폭주하는 현상 발생 
starvation mode of mutex 
고동기성 잘 안됨

깃헙에 구현체가 있는데 뮤텍스 구현체를 뜯어봤다. 
starvation 모드 1초이상 획득하지 못하면

mutex를 mapreduce의 개념을 활용 2000개 등 다양한 케이스에 대해 돌려봤고, 매직 넘버로 2000을 선택함 benchmark 사용

컨테이너 환경에서 원치않는 CPU Thrittling 경험을 해보신적 있나요? 
cpu usage는 20-30%정도로 안정적으로 유지되고 있었음
GOMAXPROCS 값을 변경해서 사용햇기 때문
known 컨테이너는 cpu 쿼타랑 고맥스프록스가 별개로 동작 
cpu에 해결된 것을 
numCPU가 cgroup에 할당된 것보다 크게 잡히면 무슨 일이 발생하는가
go runtime scheduler 구조
GMP
P는 보통 일대일 대응 cgroup보다 p가 많게 되면 p에서 처리하는 고루틴이 스케줄링 단에서 블로킹됨

automaxprocs를 도입 uber가 만들어둔것

메모리 최적화 및 GC tuning 경험이 있으신가요?